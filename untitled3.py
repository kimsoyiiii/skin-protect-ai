# -*- coding: utf-8 -*-
"""Untitled3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ScSQKnIQgaISCyLgbGCqLw38yiq7M8l1
"""

import streamlit as st
import requests
import datetime
import pandas as pd

# ì„¤ì •
st.set_page_config(page_title="í”¼ë¶€ ë³´í˜¸ AI", layout="centered")
st.title("ğŸŒ¤ï¸ AI ê¸°ë°˜ ë§ì¶¤í˜• í”¼ë¶€ ë³´í˜¸ í”„ë¡œê·¸ë¨")

# ê¸°ìƒì²­ API ì¸ì¦í‚¤ (í…ŒìŠ¤íŠ¸ìš©)
API_KEY = "rE1UBiTAA83Ww7niPLiHVd2PNvxEpqDERG8Ore1kHCy9GnAMgccbVW4m0hifrh7UlhqZ13ezac9fo5nL8%2Bh%2F4Q%3D%3D"

# í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ ì„¤ì •
def get_base_time():
    now = datetime.datetime.now()
    if now.minute < 45:
        now = now - datetime.timedelta(hours=1)
    return now.strftime("%Y%m%d"), now.strftime("%H00")

# ê¸°ìƒì²­ APIì—ì„œ ë‚ ì”¨ ë¶ˆëŸ¬ì˜¤ê¸°
def get_weather():
    base_date, base_time = get_base_time()
    url = "https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst"
    params = {
        "serviceKey": API_KEY,
        "pageNo": "1",
        "numOfRows": "100",
        "dataType": "JSON",
        "base_date": base_date,
        "base_time": base_time,
        "nx": "57",  # ê´‘ëª…ì‹œ ìœ„ì¹˜
        "ny": "126"
    }
    response = requests.get(url, params=params, timeout=10)
    if response.status_code == 200:
        return response.json()
    return None

# ë‚ ì”¨ ë°ì´í„° â†’ í”¼ë¶€ ì¡°ê±´ ë¶„ë¥˜
def interpret_weather(data):
    condition = []
    items = data['response']['body']['items']['item']
    for item in items:
        if item['category'] == 'T1H':
            temp = float(item['obsrValue'])
            if temp < 10:
                condition.append('ì¶”ì›€')
            elif temp > 27:
                condition.append('ë”ì›€')
        elif item['category'] == 'REH':
            reh = float(item['obsrValue'])
            if reh < 40:
                condition.append('ê±´ì¡°í•¨')
            elif reh > 75:
                condition.append('ìŠµí•¨')
        elif item['category'] == 'UV':
            uv = float(item['obsrValue'])
            if uv > 7:
                condition.append('ìì™¸ì„  ê°•í•¨')
    return condition

# ì¶”ì²œ ì„±ë¶„ ë§¤í•‘
recommendation_db = pd.DataFrame([
    {"status": "ì¶”ì›€", "ingredient": "ì„¸ë¼ë§ˆì´ë“œ", "effect": "ë³´ìŠµ, ì¥ë²½ ê°•í™”"},
    {"status": "ë”ì›€", "ingredient": "ì‚´ë¦¬ì‹¤ì‚°", "effect": "ëª¨ê³µ í”¼ì§€ ìš©í•´"},
    {"status": "ê±´ì¡°í•¨", "ingredient": "íˆì•Œë£¨ë¡ ì‚°", "effect": "ìˆ˜ë¶„ ìœ ì§€"},
    {"status": "ìì™¸ì„  ê°•í•¨", "ingredient": "ìì™¸ì„  ì°¨ë‹¨ì œ SPF50+", "effect": "ê´‘ë…¸í™” ë°©ì§€"},
])

# ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸°
if st.button("ğŸ”„ ë‚ ì”¨ ìƒˆë¡œê³ ì¹¨"):
    st.rerun()

weather_data = get_weather()
if weather_data:
    st.success("âœ… ë‚ ì”¨ ì •ë³´ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ì–´ìš”!")
    conditions = interpret_weather(weather_data)
    st.subheader("ğŸŒ¡ï¸ ê°ì§€ëœ í”¼ë¶€ í™˜ê²½:")
    for cond in conditions:
        st.write(f"- {cond}")

    st.subheader("ğŸ§´ ì¶”ì²œ ì„±ë¶„:")
    for cond in conditions:
        row = recommendation_db[recommendation_db['status'] == cond]
        if not row.empty:
            st.write(f"**{cond}**")
            st.write(f"- ì„±ë¶„: {row['ingredient'].values[0]}")
            st.write(f"- íš¨ê³¼: {row['effect'].values[0]}")
else:
    st.warning("â— ë‚ ì”¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.")